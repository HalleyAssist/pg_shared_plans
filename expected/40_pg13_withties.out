SET pg_shared_plans.threshold = 1;
----------------------------
-- new in pg13: WITH TIES --
----------------------------
--
-- Limit option
--
CREATE TABLE limitoption AS SELECT 0 AS val FROM generate_series(1, 10);
PREPARE limitoption_1(int) AS SELECT *
    FROM limitoption
    WHERE val < $1
    ORDER BY val
    FETCH FIRST 2 ROWS WITH TIES;
-- pg_stat_statements will generate the same queryid for this query, make sure
-- we see it as a different one
PREPARE limitoption_2(int) AS SELECT *
    FROM limitoption
    WHERE val < $1
    ORDER BY val
    FETCH FIRST 2 ROW ONLY;
EXECUTE limitoption_1(5);
 val 
-----
   0
   0
   0
   0
   0
   0
   0
   0
   0
   0
(10 rows)

EXECUTE limitoption_1(5);
 val 
-----
   0
   0
   0
   0
   0
   0
   0
   0
   0
   0
(10 rows)

EXECUTE limitoption_2(5);
 val 
-----
   0
   0
(2 rows)

EXECUTE limitoption_2(5);
 val 
-----
   0
   0
(2 rows)

-- We should see 2 entries, each having bypassed the planner once
SELECT bypass FROM pg_shared_plans WHERE query LIKE '%limitoption%';
 bypass 
--------
      1
      1
(2 rows)

